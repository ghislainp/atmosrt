

name: Publish Python ğŸ distribution ğŸ“¦ to PyPI and TestPyPI

#on: [push]
on:
 release:
   types: [published]

jobs:
  build_wheels:
    name: Build wheels on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-24.04] #, windows-2019, macOS-11]

    steps:
      - uses: actions/checkout@v4

      # Used to host cibuildwheel
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install cibuildwheel
        run: |
          python -m pip install --upgrade pip
          python -m pip install cibuildwheel==3.3.1

      - name: Build wheels
        run: python -m cibuildwheel --output-dir wheelhouse
        # to supply options, put them in 'env', like:
        env:
          # Install a NumPy that provides the oldest ABI compatible wheels
          # for each Python version (helps produce widely-compatible wheels).
          CIBW_BEFORE_BUILD: |
            python -m pip install oldest-supported-numpy
            python -m pip install "meson>=1.4" ninja

          # f2py builds require a Fortran compiler.
          # manylinux build images vary by policy/version; install gfortran via yum or dnf.
          CIBW_BEFORE_ALL_LINUX: |
            (command -v yum && yum install -y gcc-gfortran) || (command -v dnf && dnf install -y gcc-gfortran)

          # AtmosRT currently declares python_requires >= 3.10
          CIBW_BUILD: cp310-manylinux_x86_64 cp311-manylinux_x86_64 cp312-manylinux_x86_64 cp313-manylinux_x86_64

          # Smoke test the produced wheel.
          CIBW_TEST_COMMAND: python -c "import libsbdart, libsmarts_295"
        #   CIBW_SOME_OPTION: value

      - uses: actions/upload-artifact@v4
        with:
          name: cibw-wheels-${{ matrix.os }}-${{ strategy.job-index }}
          path: ./wheelhouse/*.whl

  # build_sdist:
  #   name: Build source distribution
  #   runs-on: ubuntu-24.04
  #   steps:
  #     - uses: actions/checkout@v4

  #     - name: Install numpy
  #       run: python -m pip install numpy==1.19.5

  #     - name: Build sdist
  #       run: pipx run build --sdist

  #     - uses: actions/upload-artifact@v4
  #       with:
  #         name: cibw-sdist
  #         path: dist/*.tar.gz

  publish-to-pypi:
    name: >-
      Publish Python ğŸ distribution ğŸ“¦ to PyPI
    if: startsWith(github.ref, 'refs/tags/')  # only publish to PyPI on tag pushes
    needs:
    # - build_sdist
    - build_wheels
    runs-on: ubuntu-24.04
    environment:
      name: pypi
      url: https://pypi.org/project/AtmosRT/
    permissions:
      id-token: write  # IMPORTANT: mandatory for trusted publishing

    steps:
    - name: Download wheels
      uses: actions/download-artifact@v4
      with:
        # unpacks all CIBW artifacts into dist/
        pattern: cibw-*
        path: dist/
        merge-multiple: true
    - name: Publish distribution ğŸ“¦ to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1

